name: Build Arch Linux ISO

on:
  push:
    branches: [ master, main ]
    paths:
      - 'archiso-profile/**'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build ISO in Arch Linux container
      run: |
        docker run --rm --privileged \
          -v "${{ github.workspace }}/archiso-profile:/profile:ro" \
          -v "${{ github.workspace }}/out:/output" \
          archlinux:latest \
          bash -c '
            set -e
            echo "=== Installing archiso and bootloader tools ==="
            pacman -Syu --noconfirm archiso grub mtools dosfstools libisoburn

            echo ""
            echo "=== Building ISO ==="
            mkarchiso -v -w /tmp/archiso-work -o /output /profile

            echo ""
            echo "=== Cleaning up ==="
            rm -rf /tmp/archiso-work

            echo ""
            echo "=== Build complete ==="
            ls -lh /output/*.iso
          '

    - name: Get ISO info
      id: iso_info
      run: |
        ISO_FILE=$(ls -t out/*.iso | head -n1)
        ISO_NAME=$(basename "$ISO_FILE")
        ISO_SIZE=$(du -h "$ISO_FILE" | cut -f1)
        echo "name=$ISO_NAME" >> $GITHUB_OUTPUT
        echo "size=$ISO_SIZE" >> $GITHUB_OUTPUT
        echo "path=$ISO_FILE" >> $GITHUB_OUTPUT

    - name: Upload ISO as artifact
      uses: actions/upload-artifact@v4
      with:
        name: arch-dosbox-djgpp-iso
        path: out/*.iso
        retention-days: 30
        compression-level: 0  # ISO is already compressed

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: out/*.iso
        body: |
          ## DOSBox-X DJGPP Development ISO

          **Size:** ${{ steps.iso_info.outputs.size }}

          ### What's included:
          - DOSBox-X emulator
          - DJGPP cross-compiler toolchain
          - i3 tiling window manager
          - Alacritty terminal

          ### How to use:
          1. Download the ISO
          2. Write to USB or boot in VM
          3. Login: `dosbox` / `dosbox`
          4. Type `startx` to launch

          See [ARCHISO-README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/ARCHISO-README.md) for full documentation.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build summary
      run: |
        echo "## Build Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ISO Name:** ${{ steps.iso_info.outputs.name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Size:** ${{ steps.iso_info.outputs.size }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
